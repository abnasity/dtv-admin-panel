<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhoneHub - Complete Sale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fb;
            color: var(--dark);
            padding: 20px 0;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-header {
            margin-bottom: 25px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }
        
        .scan-container {
            display: flex;
            gap: 10px;
        }

        .scan-input {
            flex: 1;
        }
        
        .device-preview {
            background: var(--light);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .device-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-weight: 500;
            font-size: 16px;
        }
        
        .payment-method {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        .payment-option {
            flex: 1;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-option.active {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        
        .payment-option i {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--gray);
        }
        
        .payment-option.active i {
            color: var(--primary);
        }
        
        .payment-option h4 {
            margin-bottom: 5px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .invalid-feedback {
            width: 100%;
            margin-top: 0.25rem;
            font-size: .875em;
            color: var(--danger);
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .form-row .form-group {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="sales" class="page active">
        <form method="POST" action="{{ url_for('sales.complete_sale') }}">
            {{ form.hidden_tag() }}
            <div class="form-container">
                <div class="page-header" style="margin-bottom:0;">
                  <h2 class="page-title"><i class="fas fa-cash-register"></i> New Sale</h2>
                </div>
              
                <h3 style="margin-bottom: 20px; margin-top: 20px;">Device IMEI</h3>
                <div class="form-group">
                    {{ form.imei(id="sales-imei-input", class="form-control", placeholder="Enter IMEI from inventory", **{'inputmode': 'numeric', 'maxlength': '15'}) }}
                    <div id="sales-imei-status" class="imei-status" style="font-size:.9rem; color:#6b7280; margin-top:6px;">
                        {% if form.imei.errors %}
                            <span class="invalid-feedback d-block">{% for error in form.imei.errors %}{{ error }}{% endfor %}</span>
                        {% else %}
                            Enter the 15-digit IMEI of the device being sold.
                        {% endif %}
                    </div>
                </div>
              
                <div class="device-preview">
                    <h3 style="margin-bottom: 15px;">Device Preview</h3>
                    <div id="device-details-content" class="device-details">
                        <div class="detail-item"><span class="detail-label">IMEI</span><span class="detail-value" id="preview-imei">-</span></div>
                        <div class="detail-item"><span class="detail-label">Brand</span><span class="detail-value" id="preview-brand">-</span></div>
                        <div class="detail-item"><span class="detail-label">Model</span><span class="detail-value" id="preview-model">-</span></div>
                        <div class="detail-item"><span class="detail-label">Storage</span><span class="detail-value" id="preview-storage">-</span></div>
                        <div class="detail-item"><span class="detail-label">Selling Price</span><span class="detail-value" id="preview-price">-</span></div>
                        <div class="detail-item"><span class="detail-label">Status</span><span class="detail-value" id="preview-status">-</span></div>
                    </div>
                    <div id="device-not-found" class="text-danger" style="display: none;">Device not found or is already sold.</div>
                </div>
              
                <h3 style="margin-bottom: 20px; margin-top: 30px;">Customer Information</h3>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="customer_name">Customer Name</label>
                            {{ form.customer_name(id="customer_name", placeholder="Enter full name") }}
                            {% if form.customer_name.errors %}<div class="invalid-feedback">{% for error in form.customer_name.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="id_number">ID Number</label>
                            {{ form.id_number(id="id_number", placeholder="Enter ID number") }}
                            {% if form.id_number.errors %}<div class="invalid-feedback">{% for error in form.id_number.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="customer_phone">Phone Number</label>
                            {{ form.customer_phone(id="customer_phone", placeholder="Enter phone number", type="tel") }}
                            {% if form.customer_phone.errors %}<div class="invalid-feedback">{% for error in form.customer_phone.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>
                    </div>
                </div>
              
                <h3 style="margin-bottom: 20px; margin-top: 20px;">Sale Information</h3>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="sale_price">Sale Price (KES)</label>
                            {{ form.sale_price(id="sale_price", type="number") }}
                            {% if form.sale_price.errors %}<div class="invalid-feedback">{% for error in form.sale_price.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="staff">Selling Staff</label>
                            <select id="staff" name="staff"> <option>James Adebayo</option>
                                <option>Fatima Sani</option>
                                <option>Chinedu Okoro</option>
                                <option>Amina Yusuf</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="shop">Select Shop</label>
                            {{ form.shop(id="shop") }}
                            {% if form.shop.errors %}<div class="invalid-feedback">{% for error in form.shop.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>
                    </div>
                </div>
              
                <h3 style="margin-bottom: 15px;">Payment Method</h3>
                 {{ form.payment_type(id="payment_type_input", style="display:none;") }}
                <div class="payment-method">
                    <div class="payment-option active" data-payment="cash">
                        <i class="fas fa-money-bill-wave"></i>
                        <h4>Cash Payment</h4>
                        <p>Full amount paid immediately</p>
                    </div>
                    <div class="payment-option" data-payment="credit">
                        <i class="fas fa-credit-card"></i>
                        <h4>Credit Payment</h4>
                        <p>Partial payment with installment plan</p>
                    </div>
                </div>
                {% if form.payment_type.errors %}<div class="invalid-feedback" style="margin-top:-15px; margin-bottom:15px;">{% for error in form.payment_type.errors %}{{ error }}{% endfor %}</div>{% endif %}

                <div class="form-group">
                    <label for="amount_paid">Amount Paid (KES)</label>
                    {{ form.amount_paid(id="amount_paid", type="number") }}
                    {% if form.amount_paid.errors %}<div class="invalid-feedback">{% for error in form.amount_paid.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
              
                <div class="form-group" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 18px;">
                        <i class="fas fa-check-circle"></i> Complete Sale
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    /* small visible status and valid styles */
    .scan-input.valid { color: #16a34a !important; border-color: #16a34a !important; }
    .imei-status.valid { color: #16a34a !important; font-weight:700; }
  
    /* scanner modal & cropper (scoped) */
    #scannerModal { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background: rgba(2,6,23,0.6); z-index: 99999; visibility:hidden; opacity:0; transition:.18s; }
    #scannerModal.open { visibility:visible; opacity:1; }
    .scannerBox { width:96%; max-width:920px; background:#fff; padding:12px; border-radius:12px; box-shadow:0 16px 60px rgba(2,6,23,0.35); }
    .video-wrap{ position:relative; border-radius:10px; overflow:hidden; background:#000; height:460px; display:flex; align-items:center; justify-content:center; }
    .video-wrap video { width:100%; height:100%; object-fit:cover; display:block; }
    canvas.overlay { position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; }
  
    /* Cropper modal */
    #cropModal { display:none; position:fixed; inset:0; align-items:center; justify-content:center; background: rgba(2,6,23,0.6); z-index:100000; }
    .cropper-card { background:#fff; padding:12px; border-radius:10px; max-width:920px; width:96%; }
    .cropper-wrap{ position:relative; height:420px; display:flex; align-items:center; justify-content:center; background:#fff; border-radius:8px; overflow:hidden; }
    #cropCanvas, #cropOverlay { position:absolute; left:0; top:0; display:block; width:100%; height:100%; }
    .btn-ghost { background:#fff; border:1px solid #e6eef8; padding:.5rem .8rem; border-radius:10px; cursor:pointer; }
    .btn-primary { background:#2563eb; color:#fff; padding:.5rem .8rem; border-radius:10px; cursor:pointer; border:0; }
    @media (max-width:980px){ .video-wrap{height:320px} .cropper-wrap{height:320px} }
</style>
  
<div id="scannerModal" aria-hidden="true">
    <div class="scannerBox" role="dialog" aria-modal="true" aria-label="IMEI scanner">
      <div class="video-wrap" id="videoWrap">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay" class="overlay"></canvas>
      </div>
      <div class="hint" style="margin-top:8px; text-align:center; color:#6b7280;">Point the camera at the phone box barcode or IMEI label.</div>
      <div style="display:flex;justify-content:space-between;margin-top:8px">
        <div style="display:flex;gap:8px">
          <button id="flipBtn" class="btn-ghost" type="button">Flip</button>
          <button id="closeBtn" class="btn-ghost" type="button">Close</button>
        </div>
        <div style="display:flex;gap:8px">
          <button id="snapBtn" class="btn-primary" type="button">Snap & Scan</button>
        </div>
      </div>
    </div>
</div>
  
<div id="cropModal" aria-hidden="true">
    <div class="cropper-card">
      <h3 style="margin:0 0 8px 0">Crop uploaded image (draw to select)</h3>
      <div class="cropper-wrap" id="cropWrap">
        <canvas id="cropCanvas"></canvas>
        <canvas id="cropOverlay"></canvas>
      </div>
      <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
        <button id="cropScanBtn" class="btn-primary" type="button">Crop & Scan</button>
        <button id="resetCropBtn" class="btn-ghost" type="button">Reset</button>
        <button id="closeCropBtn" class="btn-ghost" type="button">Close</button>
        <button id="ocrBtn" class="btn-ghost" type="button">OCR (Tesseract)</button>
        <div style="flex:1"></div>
        <div id="uploadHint" style="color:var(--muted); font-size:.95rem;"></div>
      </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const imeiInput = document.getElementById('sales-imei-input');
    imeiInput.addEventListener('input', function() {
        const imei = this.value;
        if (imei.length === 15) {
            fetch(`/sales/check_imei/${imei}`)
                .then(response => response.json())
                .then(data => {
                    if (data.found) {
                        document.getElementById('preview-imei').textContent = imei;
                        document.getElementById('preview-brand').textContent = data.brand;
                        document.getElementById('preview-model').textContent = data.model;
                        document.getElementById('preview-storage').textContent = data.rom + 'GB';
                        document.getElementById('preview-price').textContent = 'Ksh ' + data.selling_price;
                        document.getElementById('preview-status').textContent = 'Available';
                        document.getElementById('preview-status').style.color = 'var(--success)';
                        document.getElementById('device-details-content').style.display = 'grid';
                        document.getElementById('device-not-found').style.display = 'none';
                        document.getElementById('sale_price').value = data.selling_price;
                    } else {
                        document.getElementById('device-details-content').style.display = 'none';
                        document.getElementById('device-not-found').style.display = 'block';
                    }
                });
        }
    });

    // Original payment selection and amount update logic
    const paymentOptions = document.querySelectorAll('.payment-option');
    const hiddenPaymentTypeInput = document.getElementById('payment_type_input');
    const salePriceInput = document.getElementById('sale_price');
    const amountPaidInput = document.getElementById('amount_paid');

    function updateAmountPaid() {
        if (!salePriceInput || !amountPaidInput || !hiddenPaymentTypeInput) return;
        const selectedPaymentType = hiddenPaymentTypeInput.value;
        if (selectedPaymentType === 'cash' && salePriceInput.value) {
            amountPaidInput.value = salePriceInput.value;
            amountPaidInput.readOnly = true;
        } else {
            amountPaidInput.readOnly = false;
        }
    }

    function setActivePaymentOption(value) {
        if (hiddenPaymentTypeInput) hiddenPaymentTypeInput.value = value;
        paymentOptions.forEach(opt => {
            opt.classList.toggle('active', opt.dataset.payment === value);
        });
    }

    paymentOptions.forEach(option => {
        option.addEventListener('click', function () {
            const selectedValue = this.dataset.payment;
            setActivePaymentOption(selectedValue);
            if (selectedValue === 'credit' && amountPaidInput.readOnly) {
                amountPaidInput.value = ''; 
            }
            updateAmountPaid();
        });
    });

    if (salePriceInput) {
        salePriceInput.addEventListener('input', updateAmountPaid);
    }
    
    function initializeState() {
        const initialPaymentType = hiddenPaymentTypeInput ? (hiddenPaymentTypeInput.value || 'cash') : 'cash';
        setActivePaymentOption(initialPaymentType);
        updateAmountPaid();
    }
    initializeState();


    // Scanner functionality from the target design
    (function(){
        'use strict';
        const PERFORMANCE = { SCAN_INTERVAL: 100, MAX_OCR_DIMENSION: 800, FAST_PREPROCESS: true };
        const $ = id => document.getElementById(id);
        const salesInput = $('sales-imei-input');
        const statusText = $('sales-imei-status');
        
        function setStatus(msg, valid=false){
            if(statusText){
                statusText.innerHTML = msg || ''; // Use innerHTML to clear previous error messages
                statusText.classList.toggle('valid', !!valid);
            }
        }
        function playBeep(){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.02; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); ctx.close(); },120);}catch(e){} }

        const imeiCache = new Map();
        function validateIMEI(imei){
            if(imeiCache.has(imei)) return imeiCache.get(imei);
            if(!/^\d{15}$/.test(imei)){ imeiCache.set(imei,false); return false; }
            let sum=0;
            for(let i=0;i<15;i++){ let d=parseInt(imei.charAt(14-i),10); if(i%2===1){ d*=2; if(d>9) d-=9; } sum+=d; }
            const ok = sum % 10 === 0; imeiCache.set(imei, ok); return ok;
        }
        function computeLuhnCheckDigit(first14){
            if(!/^[0-9]{14}$/.test(first14)) return null;
            for(let d=0; d<=9; d++) if(validateIMEI(first14 + d)) return String(d);
            return null;
        }

        function extractIMEIFromText(text){
            if(!text) return null;
            const fastMatch = text.match(/\d{15}/);
            if(fastMatch && validateIMEI(fastMatch[0])) return fastMatch[0];
            const s = String(text).replace(/\u00A0/g,' ');
            const labelRegex = /IMEI\s*1?\s*[:\-]?\s*([0-9]{14,15})/ig;
            let match, found=[];
            while((match = labelRegex.exec(s)) !== null) found.push(match[1]);
            if(found.length){
                for(const cand of found) if(cand.length===15 && validateIMEI(cand)) return cand;
                for(const cand of found) if(cand.length===14){ const cd = computeLuhnCheckDigit(cand); if(cd!==null) return cand + cd; }
                return found[0];
            }
            const seq15 = s.match(/\d{15}/g);
            if(seq15 && seq15.length){ for(const t of seq15) if(validateIMEI(t)) return t; return seq15[0]; }
            const seq14 = s.match(/\d{14}/g);
            if(seq14 && seq14.length){ for(const t of seq14){ const cd = computeLuhnCheckDigit(t); if(cd!==null) return t + cd; } return seq14[0]; }
            return null;
        }

        const canvasPool = [];
        function getCanvasFromPool(){ if(canvasPool.length>0) return canvasPool.pop(); const c=document.createElement('canvas'); c.style.display='none'; return c; }
        function returnCanvasToPool(c){ if(canvasPool.length<5) canvasPool.push(c); }

        function drawVideoToCanvas(canvas, videoEl, scale = 0.7){
            const w = Math.floor((videoEl.videoWidth || videoEl.clientWidth) * scale);
            const h = Math.floor((videoEl.videoHeight || videoEl.clientHeight) * scale);
            if(!w || !h) return false;
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            ctx.drawImage(videoEl, 0, 0, w, h);
            return true;
        }

        function preprocessForOCR(srcCanvas, maxDim = PERFORMANCE.MAX_OCR_DIMENSION){
            const sw = srcCanvas.width, sh = srcCanvas.height;
            const scale = Math.min(1, maxDim / Math.max(sw, sh));
            const tw = Math.max(1, Math.round(sw * scale)), th = Math.max(1, Math.round(sh * scale));
            const out = getCanvasFromPool();
            out.width = tw; out.height = th;
            const octx = out.getContext('2d');
            octx.drawImage(srcCanvas, 0, 0, tw, th);
            if(PERFORMANCE.FAST_PREPROCESS){
                const im = octx.getImageData(0,0,tw,th);
                const d = im.data; const contrast = 1.3;
                for(let i=0;i<d.length;i+=4){
                    const lum = (d[i]+d[i+1]+d[i+2]) / 3; let v = (lum - 128) * contrast + 128; v = Math.max(0, Math.min(255, v));
                    d[i] = d[i+1] = d[i+2] = v;
                }
                octx.putImageData(im,0,0);
            }
            return out;
        }

        let tesseractWorker = null;
        async function loadTesseract(){
            if(tesseractWorker) return tesseractWorker;
            if(!window.Tesseract) throw new Error('Tesseract not available');
            tesseractWorker = window.Tesseract.createWorker({ logger: m => {} });
            await tesseractWorker.load(); await tesseractWorker.loadLanguage('eng'); await tesseractWorker.initialize('eng');
            return tesseractWorker;
        }

        (function warmTesseract(){
            setTimeout(()=>{ if(window.Tesseract) { loadTesseract().catch(()=>{}); } }, 1200);
        })();

        function CameraScanner(scope){
            const { scannerModal, video, overlay } = scope;
            let currentStream = null, useFront = false, detectionInterval = null, isProcessing = false;

            async function startCamera(isFront = false){
                useFront = isFront;
                stopCamera(); stopDetection();
                try{
                    setStatus('Requesting camera...');
                    const constraints = { video: { facingMode: useFront ? 'user' : 'environment', width:{ ideal:1280 }, height:{ ideal:720 } }, audio:false };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    currentStream = stream; video.srcObject = stream;
                    await new Promise((res, rej) => { video.onloadedmetadata = ()=>res(); video.onerror = e=>rej(e); });
                    try{ await video.play(); }catch(e){}
                    overlay.width = video.clientWidth; overlay.height = video.clientHeight;
                    setStatus('Camera ready — scanning');
                    if('BarcodeDetector' in window) startOptimizedDetection(); else setStatus('No native barcode support — use Snap & Scan');
                }catch(e){
                    setStatus('Camera not available — use Upload');
                }
            }
            function stopCamera(){
                if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; }
                try{ video.srcObject = null; }catch(e){}
                stopDetection();
            }
            function stopDetection(){ if(detectionInterval){ clearInterval(detectionInterval); detectionInterval=null; } isProcessing=false; }
            function startOptimizedDetection(){
                setStatus('Starting continuous detection');
                detectionInterval = setInterval(async ()=>{
                    if(!scannerModal.classList.contains('open') || isProcessing) return;
                    try{
                        const c = getCanvasFromPool();
                        if(!drawVideoToCanvas(c, video, 0.6)){ returnCanvasToPool(c); return; }
                        const detector = new BarcodeDetector({ formats: ['code_128','ean_13','ean_8','upc_a','upc_e'] });
                        const results = await detector.detect(c);
                        if(results && results.length){
                            const raw = results[0].rawValue || '';
                            if(results[0].boundingBox) drawOverlayRect(results[0].boundingBox, c, video, overlay);
                            const candidate = extractIMEIFromText(raw);
                            if(candidate){ processFound(candidate); returnCanvasToPool(c); return; }
                        }
                        returnCanvasToPool(c);
                    }catch(e){}
                }, PERFORMANCE.SCAN_INTERVAL);
            }
            async function manualSnap(){
                if(isProcessing){ setStatus('Processing...'); return; }
                const c = getCanvasFromPool();
                if(!drawVideoToCanvas(c, video, 0.8)){ setStatus('Camera not ready'); returnCanvasToPool(c); return; }
                setStatus('Captured frame — scanning');
                try{
                    isProcessing=true;
                    if('BarcodeDetector' in window){
                        try{
                            const detector = new BarcodeDetector({ formats: ['code_128','ean_13','ean_8','upc_a','upc_e'] });
                            const results = await detector.detect(c);
                            if(results && results.length){
                                const raw = results[0].rawValue || '';
                                const candidate = extractIMEIFromText(raw);
                                if(candidate){ processFound(candidate); returnCanvasToPool(c); isProcessing=false; return; }
                            }
                        }catch(e){}
                    }
                    const pre = preprocessForOCR(c, 600);
                    const worker = await loadTesseract();
                    const result = await worker.recognize(pre);
                    const candidate = extractIMEIFromText(result.data.text);
                    if(candidate) processFound(candidate); else setStatus('No IMEI found. Try moving closer.');
                    returnCanvasToPool(c);
                }catch(e){ setStatus('Snap failed'); } finally { isProcessing=false; }
            }
            function drawOverlayRect(bb, srcCanvas, videoEl, overlayEl){
                try{
                    const displayScaleX = videoEl.clientWidth / srcCanvas.width;
                    const displayScaleY = videoEl.clientHeight / srcCanvas.height;
                    const rect = { x: bb.x * displayScaleX, y: bb.y * displayScaleY, width: bb.width * displayScaleX, height: bb.height * displayScaleY };

                    const ov = overlayEl;
                    ov.width = videoEl.clientWidth; ov.height = videoEl.clientHeight;
                    const ctx = ov.getContext('2d'); ctx.clearRect(0,0,ov.width,ov.height);
                    ctx.lineWidth = 3; ctx.strokeStyle = '#22c55e'; ctx.fillStyle = '#22c55e22';
                    ctx.strokeRect(rect.x, rect.y, rect.width, rect.height);
                    ctx.fillRect(rect.x, rect.y, rect.width, rect.height);
                    setTimeout(()=>{ try{ ctx.clearRect(0,0,ov.width,ov.height); } catch(e){} }, 1200);
                }catch(e){}
            }
            return { startCamera, stopCamera, manualSnap, stopAll: stopCamera };
        }

        function UploadScanner(scope){
            const { cropModal, cropCanvas, cropOverlay, cropWrap, uploadHint } = scope;
            let uploadedImage = null;
            let cropState = { drawing:false, startX:0, startY:0, x:0, y:0, w:100, h:60 };

            function openCropModalWithImage(img){
                uploadedImage = img;
                cropModal.style.display = 'flex'; // Show modal first

                // Defer canvas drawing until after the modal is visible
                setTimeout(() => {
                    const rect = cropWrap.getBoundingClientRect();
                    const cw = Math.floor(rect.width), ch = Math.floor(rect.height);
                    [cropCanvas.width, cropCanvas.height, cropOverlay.width, cropOverlay.height] = [cw,ch,cw,ch];
                    
                    const ctx = cropCanvas.getContext('2d');
                    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,cw,ch);
                    const scale = Math.min(cw / img.width, ch / img.height);
                    const drawW = Math.round(img.width * scale), drawH = Math.round(img.height * scale);
                    const offsetX = Math.round((cw - drawW) / 2), offsetY = Math.round((ch - drawH) / 2);
                    ctx.drawImage(img, offsetX, offsetY, drawW, drawH);
                    
                    cropState = { drawing:false, startX:0, startY:0, x: offsetX + Math.round(drawW * 0.05), y: offsetY + Math.round(drawH * 0.1), w: Math.round(drawW * 0.9), h: Math.round(drawH * 0.8) };
                    
                    drawCropOverlay();
                    uploadHint.textContent = `Image ${img.width}×${img.height}`;
                    setStatus('Adjust crop then press Crop & Scan');
                }, 50); // 50ms delay is a small buffer to ensure rendering
            }
            function closeCropModal(){ cropModal.style.display = 'none'; uploadedImage = null; }
            function drawCropOverlay(){
                const ov = cropOverlay, ctx = ov.getContext('2d'), r = cropState;
                ctx.clearRect(0,0,ov.width,ov.height); ctx.setLineDash([6,4]); ctx.strokeStyle = '#60a5fa'; ctx.lineWidth = 2;
                ctx.strokeRect(r.x + 1, r.y + 1, r.w - 2, r.h - 2); ctx.setLineDash([]); ctx.fillStyle = 'rgba(96,165,250,0.08)';
                ctx.fillRect(r.x, r.y, r.w, r.h);
                const drawHandle = (x,y) => { ctx.fillStyle='#fff'; ctx.strokeStyle='#60a5fa'; ctx.lineWidth=1; ctx.fillRect(x-6,y-6,12,12); ctx.strokeRect(x-6,y-6,12,12); };
                [ [r.x,r.y], [r.x+r.w, r.y], [r.x, r.y+r.h], [r.x+r.w, r.y+r.h] ].forEach(([x,y]) => drawHandle(x,y));
            }
            function getLocalCoords(ev, canvas){
                const rect = canvas.getBoundingClientRect();
                return { x: Math.max(0, Math.min(canvas.width, (ev.clientX - rect.left) * (canvas.width / rect.width))), y: Math.max(0, Math.min(canvas.height, (ev.clientY - rect.top) * (canvas.height / rect.height))) };
            }
            function setupCropEvents(){
                const el = cropOverlay;
                const onPointerMove = (ev)=>{ if(!cropState.drawing) return; ev.preventDefault(); const p = getLocalCoords(ev, el); const sx = Math.min(cropState.startX, p.x), sy = Math.min(cropState.startY, p.y); cropState.x = sx; cropState.y = sy; cropState.w = Math.max(10, Math.max(cropState.startX, p.x) - sx); cropState.h = Math.max(10, Math.max(cropState.startY, p.y) - sy); drawCropOverlay(); };
                const onPointerEnd = ()=>{ cropState.drawing = false; };
                el.addEventListener('pointerdown', (ev)=>{ ev.preventDefault(); const p = getLocalCoords(ev, el); cropState = {...cropState, drawing:true, startX:p.x, startY:p.y, x:p.x, y:p.y, w:2, h:2}; drawCropOverlay(); });
                el.addEventListener('pointermove', onPointerMove);
                el.addEventListener('pointerup', onPointerEnd); el.addEventListener('pointerleave', onPointerEnd);
            }

            async function cropAndScan(useOCR = false){
                if(!uploadedImage) return setStatus('No image loaded');
                const { x, y, w, h } = cropState;
                const tempCanvas = getCanvasFromPool();
                tempCanvas.width = w; tempCanvas.height = h;
                const ctx = tempCanvas.getContext('2d');
                ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, w, h); ctx.drawImage(cropCanvas, x, y, w, h, 0, 0, w, h);
                setStatus('Scanning cropped area...');
                try {
                    if(!useOCR && 'BarcodeDetector' in window){
                        const detector = new BarcodeDetector({ formats: ['code_128','ean_13','upc_a','upc_e'] });
                        const results = await detector.detect(tempCanvas);
                        if(results && results.length){
                            const imei = extractIMEIFromText(results[0].rawValue || '');
                            if(imei){ processFound(imei); returnCanvasToPool(tempCanvas); return; }
                        }
                    }
                    const pre = preprocessForOCR(tempCanvas, 700);
                    const worker = await loadTesseract();
                    const result = await worker.recognize(pre);
                    const imei = extractIMEIFromText(result.data.text);
                    if(imei) processFound(imei); else setStatus('No IMEI detected — adjust crop and retry');
                    returnCanvasToPool(tempCanvas);
                } catch(e){ setStatus('Scanning failed'); }
            }
            function resetCrop(){ if(uploadedImage) openCropModalWithImage(uploadedImage); setStatus('Crop reset'); }
            setupCropEvents();
            return { openCropModalWithImage, closeCropModal, cropAndScan, resetCrop };
        }

        function processFound(imei){
            if(!imei || !salesInput) return setStatus('No valid IMEI');
            salesInput.value = imei;
            salesInput.classList.add('valid');
            setStatus('IMEI Detected ✓', true);
            playBeep();
            closeAllModals();
        }

        function closeAllModals(){
            const scannerModal = $('scannerModal');
            if(scannerModal) scannerModal.classList.remove('open');
            cameraScanner.stopAll();
            uploadScanner.closeCropModal();
        }

        const cameraScanner = CameraScanner({ scannerModal: $('scannerModal'), video: $('video'), overlay: $('overlay') });
        const uploadScanner = UploadScanner({ cropModal: $('cropModal'), cropCanvas: $('cropCanvas'), cropOverlay: $('cropOverlay'), cropWrap: $('cropWrap'), uploadHint: $('uploadHint') });

        $('sales-scan-btn')?.addEventListener('click', ()=>{ $('scannerModal').classList.add('open'); cameraScanner.startCamera(); });
        $('closeBtn')?.addEventListener('click', closeAllModals);
        $('flipBtn')?.addEventListener('click', ()=> cameraScanner.startCamera(true));
        $('snapBtn')?.addEventListener('click', ()=> cameraScanner.manualSnap());

        const fileInput = $('fileInput');
        fileInput?.addEventListener('change', (ev)=>{
            const file = ev.target.files[0]; if(!file) return;
            const img = new Image();
            img.onload = ()=> uploadScanner.openCropModalWithImage(img);
            img.onerror = () => setStatus('Failed to load image.');
            img.src = URL.createObjectURL(file);
            ev.target.value = ''; // Reset file input
        });
        $('cropScanBtn')?.addEventListener('click', ()=> uploadScanner.cropAndScan(false));
        $('ocrBtn')?.addEventListener('click', ()=> uploadScanner.cropAndScan(true));
        $('resetCropBtn')?.addEventListener('click', ()=> uploadScanner.resetCrop());
        $('closeCropBtn')?.addEventListener('click', ()=> uploadScanner.closeCropModal());
    })();
});
</script>

</body>
</html>