{% extends "layouts/base.html" %}

{% block title %}Add Device - Phone Sales Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="card-title mb-0">Add New Device</h2>
                   <a href="{{ url_for('devices.inventory') }}" class="btn btn-success shadow-sm">
                        <i class="fas fa-arrow-left me-1"></i> Back to Inventory
                    </a>
                </div>
                <div class="card-body">
                    <form id="deviceForm" method="POST" enctype="multipart/form-data">
                        {{ form.csrf_token }}
                    
                        <!-- Scanner Section -->
                        <div class="mb-3">
                            <label for="imeiInputField" class="form-label">IMEI (15-digit)</label>
                            <input type="text" name="imei" id="imeiInputField" class="form-control" placeholder="Scan or enter 15-digit IMEI" required>
                            <div id="scanned-result" class="form-text"></div>
                        </div>
  
                        <div class="text-center mb-3">
                            <button type="button" class="btn btn-success me-2" id="startButton">
                                <i class="fas fa-camera"></i> Start Scanner
                            </button>
                            <button type="button" class="btn btn-secondary" id="stopButton" disabled>
                                <i class="fas fa-stop"></i> Stop Scanner
                            </button>
                        </div>

                        <div id="scanner-status" class="text-danger mb-2"></div>
                        <div id="scanner" class="border border-2 rounded shadow-sm w-100 mt-3" style="height: 180px; display: none;"></div>
                        
                        <!-- Rest of your form fields -->
                        <!-- ... (keep your existing form fields) ... -->
                        
                        <div class="text-end">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const scannerStatus = document.getElementById('scanner-status');
        const scannerElement = document.getElementById('scanner');
        const imeiInput = document.getElementById('imeiInputField');
        const scannedResult = document.getElementById('scanned-result');
        
        let scannerActive = false;

        // Check for camera support
        if (!navigator.mediaDevices || typeof Quagga === 'undefined') {
            scannerStatus.textContent = "Camera or barcode scanning is not supported in your browser.";
            startButton.disabled = true;
            return;
        }

        function startScanner() {
            scannerStatus.textContent = "Initializing scanner...";
            startButton.disabled = true;
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerElement,
                    constraints: {
                        facingMode: "environment",
                        focusMode: "continuous"
                    }
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "code_39_reader"],
                    multiple: false
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error("Scanner init error:", err);
                    scannerStatus.textContent = "Error initializing scanner: " + err.message;
                    startButton.disabled = false;
                    return;
                }
                
                scannerElement.style.display = 'block';
                Quagga.start();
                scannerActive = true;
                stopButton.disabled = false;
                scannerStatus.textContent = "Scanner ready - point at a barcode";
            });
        }

        function stopScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
                scannerElement.style.display = 'none';
                startButton.disabled = false;
                stopButton.disabled = true;
                scannerStatus.textContent = "Scanner stopped";
            }
        }

        Quagga.onDetected(function(result) {
            const code = result.codeResult.code.trim();
            
            // Validate IMEI (15 digits)
            if (/^\d{15}$/.test(code)) {
                imeiInput.value = code;
                scannedResult.textContent = "Scanned IMEI: " + code;
                scannedResult.className = "form-text text-success";
                stopScanner();
            } else {
                scannedResult.textContent = "Invalid IMEI (needs 15 digits): " + code;
                scannedResult.className = "form-text text-danger";
            }
        });

        // Button event listeners
        startButton.addEventListener('click', startScanner);
        stopButton.addEventListener('click', stopScanner);

        // Clean up when leaving page
        window.addEventListener('beforeunload', function() {
            if (scannerActive) {
                Quagga.stop();
            }
        });
    });
</script>
{% endblock %}