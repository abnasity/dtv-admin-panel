{% extends "layouts/base.html" %}

{% block title %}Add Device - Phone Sales Management{% endblock %}

{% block extra_css %}
<style>
    #video, #canvas {
      max-width: 100%;
      border: 2px solid #ccc;
      margin-bottom: 10px;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="card-title mb-0">Add New Device</h2>
                    <a href="{{ url_for('devices.inventory') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Inventory
                    </a>
                </div>
                <div class="card-body">
                    <form id="deviceForm" method="POST" enctype="multipart/form-data">
                        {{ form.csrf_token }}
                      
                        
                        <!-- Scanner Section -->
                                    <div class="mb-3">
                            <label for="imeiInputField" class="form-label">IMEI (15-digit)</label>
                            <input type="text" name="imei" id="imeiInputField" class="form-control" placeholder="Scan or enter 15-digit IMEI" required>
                            </div>

                            <div class="text-center mb-3">
                            <button type="button" class="btn btn-success me-2" id="startButton">
                                <i class="fas fa-camera"></i> Start Scanner
                            </button>
                            <button type="button" class="btn btn-secondary" id="stopButton" disabled>
                                <i class="fas fa-stop"></i> Stop Scanner
                            </button>
                            </div>

                            <div id="scanner-status" class="text-danger"></div>

                            <div id="interactive" class="mt-3"></div>
                        </div>
                        
                        <!-- Rest of your form fields -->
                        <div class="mb-3">
                            {{ form.brand.label(class="form-label") }}
                            {{ form.brand(class="form-control", required=true) }}
                            {% if form.brand.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.brand.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.model.label(class="form-label") }}
                            {{ form.model(class="form-control", required=true) }}
                            {% if form.model.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.model.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.ram.label(class="form-label") }}
                            {{ form.ram(class="form-control", required=true) }}
                            {% if form.ram.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.ram.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.rom.label(class="form-label") }}
                            {{ form.rom(class="form-control", required=true) }}
                            {% if form.rom.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.rom.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.purchase_price.label(class="form-label") }}
                            <div class="input-group">
                                <span class="input-group-text">Ksh</span>
                                {{ form.purchase_price(class="form-control", required=true) }}
                            </div>
                            {% if form.purchase_price.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.purchase_price.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.price_cash.label(class="form-label") }}
                            <div class="input-group">
                                <span class="input-group-text">Ksh</span>
                                {{ form.price_cash(class="form-control", required=true) }}
                            </div>
                            {% if form.price_cash.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.price_cash.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}                        
                        </div>

                        <div class="mb-3">
                            {{ form.price_credit.label(class="form-label") }}
                            <div class="input-group">
                                <span class="input-group-text">Ksh</span>
                                {{ form.price_credit(class="form-control", required=true) }}
                            </div>
                            {% if form.price_credit.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.price_credit.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control", rows=3) }}
                            {% if form.notes.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.notes.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div> 
                        
              
                        <div class="text-end">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
<!-- Scripts -->
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

<script>
    const video = document.createElement('video');
    video.setAttribute('id', 'video');
    video.setAttribute('width', '400');
    video.setAttribute('height', '300');
    video.setAttribute('autoplay', true);

    const canvas = document.createElement('canvas');
    canvas.setAttribute('id', 'canvas');
    canvas.setAttribute('width', '400');
    canvas.setAttribute('height', '300');
    canvas.style.display = 'none';

    const scannerContainer = document.getElementById('interactive');
    scannerContainer.appendChild(video);
    scannerContainer.appendChild(canvas);

    const scannerStatus = document.getElementById('scanner-status');
    const imeiField = document.getElementById('imeiInputField');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');

    let stream;

    startButton.addEventListener('click', async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }
            });
            video.srcObject = stream;
            scannerStatus.textContent = "Scanning... Point your camera at the IMEI.";
            stopButton.disabled = false;
            startButton.disabled = true;

            const interval = setInterval(async () => {
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const result = await Tesseract.recognize(canvas, 'eng');
                const rawText = result.data.text;
                const match = rawText.match(/\b\d{15}\b/);  // Match 15-digit IMEI

                if (match) {
                    imeiField.value = match[0];
                    scannerStatus.textContent = "IMEI Detected: " + match[0];
                    clearInterval(interval);
                    stopScanner();
                }
            }, 2000);
        } catch (err) {
            scannerStatus.textContent = "Camera access failed.";
            console.error(err);
        }
    });


    stopButton.addEventListener('click', stopScanner);

    function stopScanner() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
        startButton.disabled = false;
        stopButton.disabled = true;
        scannerStatus.textContent = "";
    }
</script>
{% endblock %}
