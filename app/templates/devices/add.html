{% extends "layouts/base.html" %}

{% block title %}Add Device - Phone Sales Management{% endblock %}

{% block extra_css %}
<style>
/* Scanner container with better visibility */
#scanner-container {
    position: relative;
    width: 100%;
    max-width: 400px;
    height: 150px; /* Increased height for better scanning */
    margin: 20px auto;
    overflow: hidden;
    border: 3px solid #dc3545;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.05);
}

/* Moving scan line */
.scan-line {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: #28a745;
    animation: moveLine 2s linear infinite;
    z-index: 10;
}
@keyframes moveLine {
    from { top: 0; }
    to { top: 100%; }
}

/* Scanner status message */
#scanner-status {
    text-align: center;
    margin: 10px 0;
    font-weight: 500;
    min-height: 24px;
}

/* Video element styling */
#scanner-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="card-title mb-0">Add New Device</h2>
                    <a href="{{ url_for('devices.inventory') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Inventory
                    </a>
                </div>
                <div class="card-body">
                    <form id="deviceForm" method="POST" enctype="multipart/form-data">
                        {{ form.csrf_token }}

                        <!-- IMEI Input Field -->
                        <div class="mb-3">
                            <label for="imeiInputField" class="form-label">IMEI Number</label>
                            <div class="input-group">
                                <input type="text" id="imeiInputField" name="imei" 
                                       class="form-control" placeholder="Scanned IMEI will appear here"
                                       pattern="\d{15}" title="15 digit IMEI number" required>
                                <button type="button" id="rescanBtn" class="btn btn-outline-secondary">
                                    <i class="fas fa-sync-alt"></i> Rescan
                                </button>
                            </div>
                            <div id="imei-feedback" class="form-text"></div>
                        </div>

                        <!-- Scanner Container -->
                        <div id="scanner-container">
                            <video id="scanner-video"></video>
                            <div class="scan-line"></div>
                        </div>
                        <p id="scanner-status" class="text-info">⌛ Preparing scanner...</p>

                        <!-- Rest of your form fields remain unchanged -->
                        <!-- ... -->

                        <div class="text-end mt-4">
                            <button type="button" id="startScannerBtn" class="btn btn-success me-2">
                                <i class="fas fa-camera"></i> Start Scanner
                            </button>
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const imeiInput = document.getElementById('imeiInputField');
    const scannerStatus = document.getElementById('scanner-status');
    const startBtn = document.getElementById('startScannerBtn');
    const rescanBtn = document.getElementById('rescanBtn');
    const imeiFeedback = document.getElementById('imei-feedback');
    const videoElement = document.getElementById('scanner-video');
    
    let scannerActive = false;
    let lastScanTime = 0;
    const scanCooldown = 2000; // 2 seconds between scans

    // Initialize scanner
    function initScanner() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: videoElement,
                constraints: {
                    width: 640,
                    height: 480,
                    facingMode: "environment",
                    focusMode: "continuous"
                },
            },
            decoder: {
                readers: ["code_128_reader", "ean_reader"],
                multiple: false
            },
            locate: true,
            numOfWorkers: 4
        }, function(err) {
            if (err) {
                console.error("Scanner error:", err);
                scannerStatus.innerHTML = `<span class="text-danger">❌ Error: ${err.message || "Camera access denied"}</span>`;
                startBtn.disabled = false;
                return;
            }
            
            scannerActive = true;
            scannerStatus.innerHTML = '<span class="text-success">✅ Scanner ready - point at barcode</span>';
            Quagga.start();
        });

        Quagga.onDetected(function(result) {
            const now = Date.now();
            if (now - lastScanTime < scanCooldown) return;
            lastScanTime = now;
            
            const code = result.codeResult.code.replace(/\D/g, ''); // Remove non-digits
            console.log("Scanned code:", code);
            
            if (/^\d{15}$/.test(code)) {
                imeiInput.value = code;
                imeiFeedback.innerHTML = '<span class="text-success">✓ Valid IMEI scanned</span>';
                scannerStatus.innerHTML = '<span class="text-success">✅ IMEI captured successfully!</span>';
                
                // Optional: Play success sound
                try {
                    new Audio('{{ url_for("static", filename="sounds/success.mp3") }}').play();
                } catch(e) { console.log("Audio error:", e); }
                
                // Stop scanner after successful scan
                stopScanner();
            } else {
                imeiFeedback.innerHTML = '<span class="text-danger">✗ Invalid IMEI format (must be 15 digits)</span>';
                scannerStatus.innerHTML = '<span class="text-warning">⚠ Invalid IMEI format. Try again.</span>';
                
                // Optional: Play error sound
                try {
                    new Audio('{{ url_for("static", filename="sounds/error.mp3") }}').play();
                } catch(e) { console.log("Audio error:", e); }
            }
        });
    }

    function stopScanner() {
        if (scannerActive) {
            Quagga.stop();
            scannerActive = false;
            scannerStatus.textContent = "Scanner stopped";
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
            }
        }
    }

    // Event listeners
    startBtn.addEventListener('click', function() {
        if (!scannerActive) {
            this.disabled = true;
            scannerStatus.innerHTML = '<span class="text-info">⌛ Initializing scanner...</span>';
            initScanner();
        }
    });

    rescanBtn.addEventListener('click', function() {
        stopScanner();
        imeiInput.value = '';
        imeiFeedback.textContent = '';
        startBtn.disabled = false;
        scannerStatus.innerHTML = '<span class="text-info">Ready to scan</span>';
    });

    // Clean up when leaving page
    window.addEventListener('beforeunload', stopScanner);
});
</script>
{% endblock %}