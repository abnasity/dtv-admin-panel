{% extends "layouts/base.html" %}

{% block title %}Inventory - Diamond Tree Ventures{% endblock %}

{% block content %}
{% block extra_css %}
<style>
@media (max-width: 768px) {
.inventory-actions {
    display: flex;
    flex-wrap: wrap;
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
}

.search-box {
    background-color: #f1f1f1;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    width: 100%;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
}
.search-box input {
    border: none;
    background: transparent;
    outline: none;
    flex-grow: 1;
}
.btn-group {
    flex-wrap: wrap;
    gap: 0.5rem;
    }
.btn-group .btn {
  flex: 1 1 45%;
}
.text-end {
        text-align: center !important;
    }
.table-responsive {
        overflow-x: auto;
    }
.btn-gradient {
        background: linear-gradient(135deg, #4e73df, #224abe);
        border: none;
        color: white;
    }

.btn-gradient:hover {
        background: linear-gradient(135deg, #3e5edc, #1a3b99);
    }

.btn-primary:hover {
        background-color: #0056b3;
        transition: background-color 0.3s ease;
    }
.input-group-text {
    border-color: #ced4da;
}

.form-select, .form-control {
    border-radius: 8px;
}

.btn-gradient {
    background: linear-gradient(135deg, #4e73df, #224abe);
    border: none;
    color: white;
    transition: background 0.3s ease;
}

.btn-gradient:hover {
    background: linear-gradient(135deg, #3e5edc, #1a3b99);
    color: white;
}
}
</style>
{% endblock %}

<div class="row mb-4 align-items-center">
    <div class="col-md-6 col-12">
        <h2><i class="fas fa-warehouse me-2"></i>Device Inventory</h2>
    </div>
    <div class="col-md-6 col-12 text-md-end text-center d-flex flex-wrap justify-content-md-end justify-content-center gap-2 mt-2">
        <a href="{{ url_for('devices.scan_page') }}" class="btn btn-primary"><i class="fas fa-camera"></i> Scan</a>
        {% if current_user.is_admin() %}
        <a href="{{ url_for('devices.add_device') }}" class="btn btn-primary"><i class="fas fa-plus"></i> Add New Device</a>
        {% endif %}
    </div>
</div>



<!-- Filters -->
<div class="card mb-4 shadow-sm border-0">
    <div class="card-body">
        <form method="GET" class="row gy-3 gx-3 align-items-end">

            <!-- Search -->
            <div class="col-lg-5">
                <label class="form-label">Search</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" name="imei" class="form-control border-start-0"
                           placeholder="Search by IMEI, brand, model..."
                           value="{{ request.args.get('imei', '') }}">
                </div>
            </div>

 <div class="row g-3 align-items-end">

    <!-- Brand -->
    <div class="col-12 col-md-4">

        <label for="brand" class="form-label fw-semibold">Brand</label>
        <select name="brand" id="brand" class="form-select shadow-sm rounded-pill" onchange="this.form.submit()">
            <option value="">All Brands</option>
            {% for brand in brands %}
                <option value="{{ brand }}" {% if request.args.get('brand') == brand %}selected{% endif %}>{{ brand }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Status -->
    <div class="col-12 col-md-4">

        <label for="status" class="form-label fw-semibold">Status</label>
        <select name="status" id="status" class="form-select shadow-sm rounded-pill" onchange="this.form.submit()">
            <option value="">All Status</option>
            <option value="available" {% if request.args.get('status') == 'available' %}selected{% endif %}>Available</option>
            <option value="sold" {% if request.args.get('status') == 'sold' %}selected{% endif %}>Sold</option>
        </select>
    </div>

    <!-- Filter Button -->
    <div class="col-12 col-md-4">

        <button type="submit" class="btn btn-primary w-100 shadow-sm rounded-pill">
            <i class="fas fa-filter me-2"></i> Filter
        </button>
    </div>

</div>


        </form>
    </div>
</div>



<!-- Devices Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
        <table class="table table-striped table-hover table-sm">

    
                <thead>
                    <tr>
                        <th>IMEI</th>
                        <th>Brand</th>
                        <th>Model</th>
                        <th>Ram</th>
                        <th>Rom</th>
                        <th>Purchase Price</th>
                        <th>Cash Price</th>
                        <th>Credit Price</th>
                        <th>Status</th>
                        <th>Arrival Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr>
                        <td>{{ device.imei }}</td>
                        <td>{{ device.brand }}</td>
                        <td>{{ device.model }}</td>
                        <td>{{ device.ram }}</td>
                        <td>{{ device.rom }}</td>
                        <td>Ksh {{ "{:,.2f}".format(device.purchase_price or 0) }}</td>
                        <td>Ksh {{ "{:,.2f}".format(device.price_cash or 0) }}</td>
                        <td>Ksh {{ "{:,.2f}".format(device.price_credit or 0) }}</td>

                        <td>
                            <span class="badge fs-6 bg-{{ 'success' if device.status == 'available' else 'secondary' }}">
                                {{ device.status }}
                            </span>
                        </td>
                        <td>{{ device.arrival_date.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-info" 
                                        onclick="viewDevice('{{ device.imei }}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if device.is_available %}
                                <button type="button" class="btn btn-sm btn-success"
                                        onclick="createSale('{{ device.imei }}')">
                                    <i class="fas fa-shopping-cart"></i>
                                </button>
                                {% endif %}
                          {% if device.imei and device.is_available and current_user.is_admin() %}
                        <!-- Edit Button -->
                        <a href="{{ url_for('devices.edit_device', imei=device.imei) }}" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit"></i>
                        </a>

                        <!-- Delete Button -->
                        <form method="POST" action="{{ url_for('devices.delete_inventory', device_id=device.id) }}" class="d-inline" onsubmit="return confirm('Delete this device?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    {% endif %}


                                 </div>                       
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>



{% block extra_js %}
<script>
function viewDevice(imei) {
    const url = "{{ url_for('devices.view_device_by_imei', imei='__IMEI__') }}".replace('__IMEI__', imei);
    window.location.href = url;
}


function createSale(imei) {
    window.location.href = "{{ url_for('sales.new_sale') }}?imei=" + imei;
}

function editDevice(imei) {
    window.location.href = "{{ url_for('devices.edit_device', imei='') }}" + imei;
}

	// FEATURED DEVICES AND IMEI TOGGLE
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('deviceForm');
    const featuredCheckbox = document.querySelector('input[name="featured"]');
    const imeiInput = document.querySelector('input[name="imei"]');

    function toggleIMEI() {
        if (featuredCheckbox.checked) {
            imeiInput.disabled = true;
            imeiInput.value = '';
        } else {
            imeiInput.disabled = false;
        }
    }

    featuredCheckbox.addEventListener('change', toggleIMEI);
    toggleIMEI();  // Initialize on load

    form.addEventListener('submit', function (e) {
        if (!featuredCheckbox.checked && imeiInput.value.trim() === '') {
            e.preventDefault();
            alert('IMEI is required for non-featured devices.');
            imeiInput.focus();
        }
    });
});


</script>
{% endblock extra_js %}
{% endblock content %}

