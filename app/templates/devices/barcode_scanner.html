{% extends 'layouts/base.html' %}

{% block content %}
<div class="container mt-4 text-center">
    <h3><i class="fas fa-barcode me-2"></i>Scan Device IMEI</h3>
    
    <div class="scanner-container" style="max-width: 600px; margin: auto; position: relative;">
        <div id="scanner" style="width: 100%; height: 300px; background: #f8f9fa;"></div>
        <div class="scan-guide" style="position: absolute; top: 20%; bottom: 20%; left: 15%; right: 15%; border: 2px dashed rgba(0,255,0,0.5); pointer-events: none;"></div>
        <div class="scan-line" style="position: absolute; top: 20%; left: 15%; right: 15%; height: 2px; background: red; animation: scan 2s infinite linear;"></div>
    </div>
    
    <div class="mt-3">
        <button id="toggleCamera" class="btn btn-secondary btn-sm">Switch Camera</button>
        <button id="flashToggle" class="btn btn-secondary btn-sm ms-2">Toggle Flash</button>
    </div>
    
    <p class="mt-3 fw-bold" id="scanned-result"></p>
    <p class="text-muted">Align the barcode within the guide lines</p>
</div>

<!-- Load QuaggaJS -->
<script src="https://unpkg.com/@ericblade/quagga2@1.7.7/dist/quagga.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const resultElement = document.getElementById('scanned-result');
        const toggleCameraBtn = document.getElementById('toggleCamera');
        const flashToggleBtn = document.getElementById('flashToggle');
        
        let currentFacingMode = "environment";
        let flashActive = false;
        let stream = null;
        let track = null;

        if (!navigator.mediaDevices || typeof Quagga === 'undefined') {
            resultElement.textContent = "Camera or scanning not supported on this browser.";
            resultElement.className += ' text-danger';
            return;
        }

        function initScanner(facingMode) {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner'),
                    constraints: {
                        width: { min: 640 },
                        height: { min: 480 },
                        facingMode: facingMode,
                        aspectRatio: { ideal: 1.333 }
                    },
                    area: { // defines rectangle of the detection/localization area
                        top: "20%",    // top offset
                        right: "15%",  // right offset
                        left: "15%",   // left offset
                        bottom: "20%"  // bottom offset
                    },
                },
                decoder: {
                    readers: ["ean_reader", "ean_8_reader", "code_128_reader"],
                    multiple: false
                },
                locate: true,
                frequency: 10,
                numOfWorkers: navigator.hardwareConcurrency || 4,
            }, function (err) {
                if (err) {
                    console.error("Init error:", err);
                    resultElement.textContent = "Error initializing scanner: " + err.message;
                    resultElement.className += ' text-danger';
                    return;
                }
                
                // Get the video track for flash control
                stream = Quagga.CameraAccess.getActiveStream();
                if (stream) {
                    track = stream.getVideoTracks()[0];
                    if (track && 'applyConstraints' in track) {
                        flashToggleBtn.disabled = false;
                    }
                }
                
                Quagga.start();
                resultElement.textContent = "Scanner ready. Point camera at barcode.";
            });
        }

        // Initialize with back camera first
        initScanner(currentFacingMode);

        Quagga.onDetected(function (data) {
            let code = data.codeResult.code.trim();
            console.log("Barcode detected:", code);

            if (code.length !== 15 || !/^\d+$/.test(code)) {
                resultElement.textContent = `Invalid IMEI scanned (must be 15 digits): ${code}`;
                resultElement.className = 'mt-3 fw-bold text-danger';
                return;
            }

            Quagga.stop();
            resultElement.textContent = `Valid IMEI scanned: ${code}`;
            resultElement.className = 'mt-3 fw-bold text-success';
            
            // Delay redirect to show success message
            setTimeout(() => {
                window.location.href = `/device/${code}`;
            }, 1000);
        });

        // Camera toggle functionality
        toggleCameraBtn.addEventListener('click', function() {
            Quagga.stop();
            currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
            resultElement.textContent = "Switching camera...";
            resultElement.className = 'mt-3 fw-bold';
            initScanner(currentFacingMode);
        });

        // Flash toggle functionality
        flashToggleBtn.addEventListener('click', function() {
            if (!track || !track.getCapabilities().torch) {
                resultElement.textContent = "Flash not supported on this device";
                resultElement.className = 'mt-3 fw-bold text-warning';
                return;
            }

            flashActive = !flashActive;
            track.applyConstraints({
                advanced: [{torch: flashActive}]
            }).then(() => {
                flashToggleBtn.textContent = flashActive ? "Flash: ON" : "Flash: OFF";
            }).catch(err => {
                console.error("Flash error:", err);
                resultElement.textContent = "Error toggling flash";
                resultElement.className = 'mt-3 fw-bold text-danger';
            });
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (Quagga) {
                Quagga.stop();
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    });

    // Add CSS for scan animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes scan {
            0% { top: 20%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 80%; opacity: 0; }
        }
        .scanner-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}